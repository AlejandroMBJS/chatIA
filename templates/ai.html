{{define "ai"}}
<!DOCTYPE html>
<html lang="{{if .Lang}}{{.Lang}}{{else}}es{{end}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - AQUILA</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    {{template "navbar" .}}

    <main class="container">
        <div class="ai-container">
            <div class="ai-sidebar">
                <div class="sidebar-header">
                    <h3>{{if eq .Lang "en"}}Conversations{{else}}Conversaciones{{end}}</h3>
                    <a href="/ai/new" class="btn btn-sm btn-primary">{{if eq .Lang "en"}}New{{else}}Nueva{{end}}</a>
                </div>

                <div class="conversation-list">
                    {{range .Conversations}}
                    <a href="/ai?conv={{.ID}}"
                       class="conversation-item {{if and $.CurrentConv (eq $.CurrentConv.ID .ID)}}active{{end}}">
                        <span class="conv-title">{{.Title.String}}</span>
                        <span class="conv-date">{{formatDate .UpdatedAt}}</span>
                    </a>
                    {{else}}
                    <p class="no-conversations">{{if eq $.Lang "en"}}No conversations{{else}}No hay conversaciones{{end}}</p>
                    {{end}}
                </div>

                <div class="sidebar-footer">
                    {{if .OllamaAvailable}}
                    <span class="status-badge status-online">{{if eq .Lang "en"}}AI Available{{else}}IA Disponible{{end}}</span>
                    {{else}}
                    <span class="status-badge status-offline">{{if eq .Lang "en"}}AI Unavailable{{else}}IA No Disponible{{end}}</span>
                    {{end}}
                    <small>{{if eq .Lang "en"}}Model{{else}}Modelo{{end}}: {{.Model}}</small>
                </div>
            </div>

            <div class="ai-main">
                <div class="ai-header">
                    {{if .CurrentConv}}
                    <h2>{{.CurrentConv.Title.String}}</h2>
                    <button hx-delete="/ai/conversation/{{.CurrentConv.ID}}"
                            hx-confirm="{{if eq .Lang "en"}}Delete this conversation?{{else}}Eliminar esta conversacion?{{end}}"
                            class="btn btn-sm btn-danger">{{if eq .Lang "en"}}Delete{{else}}Eliminar{{end}}</button>
                    {{else}}
                    <h2>{{if eq .Lang "en"}}Chat with AI{{else}}Chat con IA{{end}}</h2>
                    {{end}}
                </div>

                <div id="ai-messages" class="ai-messages">
                    {{if .CurrentConv}}
                        {{range .Messages}}
                        <div class="ai-message {{if eq .Role "user"}}user-message{{else}}assistant-message{{end}} {{if .Filtered.Valid}}{{if eq .Filtered.Int64 1}}filtered-message{{end}}{{end}}">
                            <div class="message-role">
                                {{if eq .Role "user"}}{{if eq $.Lang "en"}}You{{else}}Tu{{end}}{{else}}IA{{end}}
                            </div>
                            <div class="message-content">
                                {{if and .Filtered.Valid (eq .Filtered.Int64 1)}}
                                <span class="filtered-badge">{{if eq $.Lang "en"}}Filtered{{else}}Filtrado{{end}}: {{.FilterReason.String}}</span>
                                {{end}}
                                {{.Content}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                    <div class="ai-welcome">
                        <h3>{{if eq .Lang "en"}}Welcome to AI Chat{{else}}Bienvenido al Chat con IA{{end}}</h3>
                        <p>{{if eq .Lang "en"}}Start a new conversation or select an existing one.{{else}}Inicia una nueva conversacion o selecciona una existente.{{end}}</p>
                        <p><strong>{{if eq .Lang "en"}}Security note:{{else}}Nota de seguridad:{{end}}</strong> {{if eq .Lang "en"}}Your conversations are private and protected by enterprise security filters.{{else}}Tus conversaciones son privadas y estan protegidas por filtros de seguridad empresarial.{{end}}</p>
                    </div>
                    {{end}}
                </div>

                <div id="ai-error" class="ai-error" style="display: none;"></div>
                <div id="ai-loading" class="ai-loading" style="display: none;">
                    <span class="loading-spinner"></span>
                    <span>{{if eq .Lang "en"}}Processing...{{else}}Procesando...{{end}}</span>
                </div>

                <form id="ai-form" class="ai-input-form">
                    <input type="hidden" name="conversation_id" value="{{if .CurrentConv}}{{.CurrentConv.ID}}{{else}}0{{end}}">
                    <textarea name="content" id="ai-input"
                              placeholder="{{if eq .Lang "en"}}Write your message...{{else}}Escribe tu mensaje...{{end}}"
                              rows="2" maxlength="4000"></textarea>
                    <button type="submit" class="btn btn-primary">
                        {{if eq .Lang "en"}}Send{{else}}Enviar{{end}}
                    </button>
                </form>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>AQUILA - IRIS IA Chat</p>
    </footer>

    <script>
    (function() {
        const form = document.getElementById('ai-form');
        const input = document.getElementById('ai-input');
        const messages = document.getElementById('ai-messages');
        const loading = document.getElementById('ai-loading');
        const errorDiv = document.getElementById('ai-error');
        const lang = '{{.Lang}}';

        let currentAssistantDiv = null;
        let currentContentDiv = null;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const content = input.value.trim();
            if (!content) return;

            const formData = new FormData(form);
            const convId = formData.get('conversation_id');

            addMessage('user', content);
            input.value = '';
            showLoading();
            hideError();

            currentAssistantDiv = document.createElement('div');
            currentAssistantDiv.className = 'ai-message assistant-message';
            currentAssistantDiv.innerHTML = `
                <div class="message-role">IA</div>
                <div class="message-content streaming-content"></div>
            `;
            messages.appendChild(currentAssistantDiv);
            currentContentDiv = currentAssistantDiv.querySelector('.streaming-content');
            scrollToBottom();

            try {
                const response = await fetch('/ai/stream', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Error en la solicitud');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let newConvId = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            continue;
                        }
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            try {
                                const json = JSON.parse(data);

                                if (json.conversation_id && !newConvId) {
                                    newConvId = json.conversation_id;
                                }

                                if (json.content) {
                                    currentContentDiv.textContent += json.content;
                                    scrollToBottom();
                                }

                                if (json.error) {
                                    showError(json.error);
                                }

                                if (json.reason) {
                                    currentAssistantDiv.classList.add('filtered-message');
                                    const badge = document.createElement('span');
                                    badge.className = 'filtered-badge';
                                    badge.textContent = (lang === 'en' ? 'Filtered: ' : 'Filtrado: ') + json.reason;
                                    currentContentDiv.insertBefore(badge, currentContentDiv.firstChild);
                                }
                            } catch (e) {}
                        }
                    }
                }

                if (newConvId && convId === '0') {
                    window.location.href = '/ai?conv=' + newConvId;
                }

            } catch (err) {
                showError(lang === 'en' ? 'Connection error. Try again.' : 'Error de conexion. Intenta de nuevo.');
                if (currentAssistantDiv && !currentContentDiv.textContent) {
                    currentAssistantDiv.remove();
                }
            } finally {
                hideLoading();
                currentAssistantDiv = null;
                currentContentDiv = null;
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.requestSubmit();
            }
        });

        function addMessage(role, content, filtered = false, filterReason = '') {
            const div = document.createElement('div');
            div.className = `ai-message ${role}-message ${filtered ? 'filtered-message' : ''}`;

            let html = `<div class="message-role">${role === 'user' ? (lang === 'en' ? 'You' : 'Tu') : 'IA'}</div>`;
            html += `<div class="message-content">`;
            if (filtered) {
                html += `<span class="filtered-badge">${lang === 'en' ? 'Filtered' : 'Filtrado'}: ${escapeHtml(filterReason)}</span>`;
            }
            html += escapeHtml(content);
            html += `</div>`;

            div.innerHTML = html;
            messages.appendChild(div);
            scrollToBottom();
        }

        function showLoading() {
            loading.style.display = 'flex';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(msg) {
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function scrollToBottom() {
            messages.scrollTop = messages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        scrollToBottom();
    })();
    </script>
</body>
</html>
{{end}}
