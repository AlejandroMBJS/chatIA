{{define "ai"}}
<!DOCTYPE html>
<html lang="{{if .Lang}}{{.Lang}}{{else}}es{{end}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - AQUILA</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    {{template "navbar" .}}

    <main class="container">
        <div class="ai-container">
            <div class="ai-sidebar">
                <div class="sidebar-header">
                    <h3>{{if eq .Lang "en"}}Conversations{{else}}Conversaciones{{end}}</h3>
                    <a href="/ai" class="btn btn-sm btn-primary">{{if eq .Lang "en"}}New{{else}}Nueva{{end}}</a>
                </div>

                <div class="conversation-list">
                    {{range .Conversations}}
                    <a href="/ai?conv={{.ID}}"
                       class="conversation-item {{if and $.CurrentConv (eq $.CurrentConv.ID .ID)}}active{{end}}">
                        <span class="conv-title">{{.Title.String}}</span>
                        <span class="conv-meta">
                            {{if .Model.Valid}}{{.Model.String}}{{else}}{{$.GlobalModel}}{{end}} - {{formatDate .UpdatedAt}}
                        </span>
                    </a>
                    {{else}}
                    <p class="no-conversations">{{if eq $.Lang "en"}}No conversations{{else}}No hay conversaciones{{end}}</p>
                    {{end}}
                </div>

                <div class="sidebar-footer">
                    {{if .OllamaAvailable}}
                    <span class="status-badge status-online">{{if eq .Lang "en"}}AI Available{{else}}IA Disponible{{end}}</span>
                    {{else}}
                    <span class="status-badge status-offline">{{if eq .Lang "en"}}AI Unavailable{{else}}IA No Disponible{{end}}</span>
                    {{end}}
                    <small>{{if eq .Lang "en"}}Default{{else}}Predeterminado{{end}}: {{.GlobalModel}}</small>
                </div>
            </div>

            <div class="ai-main">
                <div class="ai-header">
                    {{if .CurrentConv}}
                    <h2>{{.CurrentConv.Title.String}}</h2>
                    <button hx-delete="/ai/conversation/{{.CurrentConv.ID}}"
                            hx-confirm="{{if eq .Lang "en"}}Delete this conversation?{{else}}Eliminar esta conversacion?{{end}}"
                            class="btn btn-sm btn-danger">{{if eq .Lang "en"}}Delete{{else}}Eliminar{{end}}</button>
                    {{else}}
                    <h2>{{if eq .Lang "en"}}Chat with AI{{else}}Chat con IA{{end}}</h2>
                    {{end}}
                </div>

                <div id="ai-messages" class="ai-messages">
                    {{if .CurrentConv}}
                        {{range .Messages}}
                        <div class="ai-message {{if eq .Role "user"}}user-message{{else}}assistant-message{{end}} {{if .Filtered.Valid}}{{if eq .Filtered.Int64 1}}filtered-message{{end}}{{end}}">
                            <div class="message-role">
                                {{if eq .Role "user"}}{{if eq $.Lang "en"}}You{{else}}Tu{{end}}{{else}}IA{{end}}
                            </div>
                            <div class="message-content">
                                {{if and .Filtered.Valid (eq .Filtered.Int64 1)}}
                                <span class="filtered-badge">{{if eq $.Lang "en"}}Filtered{{else}}Filtrado{{end}}: {{.FilterReason.String}}</span>
                                {{end}}
                                {{.Content}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                    <div class="ai-welcome">
                        <h3>{{if eq .Lang "en"}}Welcome to AI Chat{{else}}Bienvenido al Chat con IA{{end}}</h3>
                        <p>{{if eq .Lang "en"}}Start a new conversation or select an existing one.{{else}}Inicia una nueva conversacion o selecciona una existente.{{end}}</p>
                        <p><strong>{{if eq .Lang "en"}}Security note:{{else}}Nota de seguridad:{{end}}</strong> {{if eq .Lang "en"}}Your conversations are private and protected by enterprise security filters.{{else}}Tus conversaciones son privadas y estan protegidas por filtros de seguridad empresarial.{{end}}</p>
                    </div>
                    {{end}}
                </div>

                <div id="ai-error" class="ai-error" style="display: none;"></div>
                <div id="ai-loading" class="ai-loading" style="display: none;">
                    <span class="loading-spinner"></span>
                    <span>{{if eq .Lang "en"}}Processing...{{else}}Procesando...{{end}}</span>
                </div>

                <form id="ai-form" class="ai-input-form" enctype="multipart/form-data">
                    <input type="hidden" name="conversation_id" value="{{if .CurrentConv}}{{.CurrentConv.ID}}{{else}}0{{end}}">
                    {{if not .CurrentConv}}
                    <div class="model-selector-row">
                        <label for="model-select">{{if eq .Lang "en"}}Model{{else}}Modelo{{end}}:</label>
                        <select name="model" id="model-select" class="model-select">
                            {{range .Models}}
                            <option value="{{.Name}}" {{if eq .Name $.Model}}selected{{end}}>{{.Name}}</option>
                            {{else}}
                            <option value="{{.GlobalModel}}">{{.GlobalModel}}</option>
                            {{end}}
                        </select>
                    </div>
                    {{else}}
                    <div class="model-indicator">
                        <small>{{if eq .Lang "en"}}Model{{else}}Modelo{{end}}: {{.Model}}</small>
                    </div>
                    {{end}}
                    <div id="file-preview" class="file-preview" style="display: none;">
                        <span class="file-name"></span>
                        <button type="button" class="file-remove" onclick="removeFile()">&times;</button>
                    </div>
                    <div class="input-row">
                        <input type="file" name="file" id="file-input" class="file-input"
                               accept=".txt,.md,.csv,.json,.xml,.html,.css,.js,.ts,.go,.py,.java,.c,.cpp,.h,.sql,.yaml,.yml,.toml,.ini,.log,.docx,.xlsx">
                        <button type="button" class="btn btn-secondary btn-attach" onclick="document.getElementById('file-input').click()" title="{{if eq .Lang "en"}}Attach file{{else}}Adjuntar archivo{{end}}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                        </button>
                        <textarea name="content" id="ai-input"
                                  placeholder="{{if eq .Lang "en"}}Write your message...{{else}}Escribe tu mensaje...{{end}}"
                                  rows="2" maxlength="4000"></textarea>
                        <button type="submit" class="btn btn-primary">
                            {{if eq .Lang "en"}}Send{{else}}Enviar{{end}}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>AQUILA - IRIS IA Chat</p>
    </footer>

    <script>
    // File handling functions (global scope)
    function removeFile() {
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        fileInput.value = '';
        filePreview.style.display = 'none';
    }

    (function() {
        const form = document.getElementById('ai-form');
        const input = document.getElementById('ai-input');
        const messages = document.getElementById('ai-messages');
        const loading = document.getElementById('ai-loading');
        const errorDiv = document.getElementById('ai-error');
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        const fileName = filePreview.querySelector('.file-name');
        const lang = '{{.Lang}}';

        let currentAssistantDiv = null;
        let currentContentDiv = null;

        // File input change handler
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                fileName.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
                filePreview.style.display = 'flex';
            } else {
                filePreview.style.display = 'none';
            }
        });

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const content = input.value.trim();
            const hasFile = fileInput.files && fileInput.files[0];

            // Allow submit if there's content OR a file
            if (!content && !hasFile) return;

            const formData = new FormData(form);
            const convId = formData.get('conversation_id');

            // Show message with file indicator if present
            let displayContent = content;
            if (hasFile) {
                displayContent = content ? content + ' [' + fileInput.files[0].name + ']' : '[' + fileInput.files[0].name + ']';
            }
            addMessage('user', displayContent);

            input.value = '';
            fileInput.value = '';
            filePreview.style.display = 'none';
            showLoading();
            hideError();

            currentAssistantDiv = document.createElement('div');
            currentAssistantDiv.className = 'ai-message assistant-message';
            currentAssistantDiv.innerHTML = `
                <div class="message-role">IA</div>
                <div class="message-content streaming-content"></div>
            `;
            messages.appendChild(currentAssistantDiv);
            currentContentDiv = currentAssistantDiv.querySelector('.streaming-content');
            scrollToBottom();

            try {
                const response = await fetch('/ai/stream', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Error en la solicitud');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let newConvId = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            continue;
                        }
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            try {
                                const json = JSON.parse(data);

                                if (json.conversation_id && !newConvId) {
                                    newConvId = json.conversation_id;
                                }

                                if (json.content) {
                                    currentContentDiv.textContent += json.content;
                                    scrollToBottom();
                                }

                                if (json.error) {
                                    showError(json.error);
                                }

                                if (json.reason) {
                                    currentAssistantDiv.classList.add('filtered-message');
                                    const badge = document.createElement('span');
                                    badge.className = 'filtered-badge';
                                    badge.textContent = (lang === 'en' ? 'Filtered: ' : 'Filtrado: ') + json.reason;
                                    currentContentDiv.insertBefore(badge, currentContentDiv.firstChild);
                                }
                            } catch (e) {}
                        }
                    }
                }

                if (newConvId && convId === '0') {
                    window.location.href = '/ai?conv=' + newConvId;
                }

            } catch (err) {
                showError(lang === 'en' ? 'Connection error. Try again.' : 'Error de conexion. Intenta de nuevo.');
                if (currentAssistantDiv && !currentContentDiv.textContent) {
                    currentAssistantDiv.remove();
                }
            } finally {
                hideLoading();
                currentAssistantDiv = null;
                currentContentDiv = null;
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.requestSubmit();
            }
        });

        function addMessage(role, content, filtered = false, filterReason = '') {
            const div = document.createElement('div');
            div.className = `ai-message ${role}-message ${filtered ? 'filtered-message' : ''}`;

            let html = `<div class="message-role">${role === 'user' ? (lang === 'en' ? 'You' : 'Tu') : 'IA'}</div>`;
            html += `<div class="message-content">`;
            if (filtered) {
                html += `<span class="filtered-badge">${lang === 'en' ? 'Filtered' : 'Filtrado'}: ${escapeHtml(filterReason)}</span>`;
            }
            html += escapeHtml(content);
            html += `</div>`;

            div.innerHTML = html;
            messages.appendChild(div);
            scrollToBottom();
        }

        function showLoading() {
            loading.style.display = 'flex';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(msg) {
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function scrollToBottom() {
            messages.scrollTop = messages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        scrollToBottom();
    })();
    </script>
</body>
</html>
{{end}}
