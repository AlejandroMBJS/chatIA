{{define "admin_users"}}
<!DOCTYPE html>
<html lang="{{if .Lang}}{{.Lang}}{{else}}es{{end}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - AQUILA</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    {{template "navbar" .}}
    <main class="container">
<div class="admin-container">
    <div class="admin-header">
        <h1>Gestion de Usuarios</h1>
        <div class="admin-nav">
            <a href="/admin" class="btn btn-secondary">Dashboard</a>
            <a href="/admin/users" class="btn btn-primary">Usuarios</a>
            <a href="/admin/filters" class="btn btn-secondary">Filtros</a>
            <a href="/admin/logs" class="btn btn-secondary">Logs</a>
            <a href="/admin/knowledge" class="btn btn-secondary">Conocimiento</a>
        </div>
    </div>

    {{if .PendingUsers}}
    <section class="admin-section">
        <h2>Usuarios Pendientes ({{len .PendingUsers}})</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Nomina</th>
                    <th>Nombre</th>
                    <th>Departamento</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody hx-target="closest tr" hx-swap="outerHTML">
                {{range .PendingUsers}}
                <tr id="pending-{{.ID}}">
                    <td>{{.Nomina}}</td>
                    <td>{{.Nombre}}</td>
                    <td>{{.Departamento.String}}</td>
                    <td>{{.CreatedAt}}</td>
                    <td class="actions">
                        <button hx-post="/admin/approve/{{.ID}}"
                                class="btn btn-sm btn-success">Aprobar</button>
                        <button hx-post="/admin/reject/{{.ID}}"
                                hx-confirm="Rechazar a este usuario?"
                                class="btn btn-sm btn-danger">Rechazar</button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </section>
    {{end}}

    <section class="admin-section">
        <h2>Todos los Usuarios ({{len .AllUsers}})</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Nomina</th>
                    <th>Nombre</th>
                    <th>Departamento</th>
                    <th>Estado</th>
                    <th>Rol</th>
                    <th>Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody hx-target="closest tr" hx-swap="outerHTML">
                {{range .AllUsers}}
                <tr id="user-{{.ID}}">
                    <td><strong>{{.Nomina}}</strong></td>
                    <td>{{.Nombre}}</td>
                    <td>{{if .Departamento.String}}{{.Departamento.String}}{{else}}-{{end}}</td>
                    <td>
                        {{if eq .Approved.Int64 1}}
                        <span class="status-badge status-approved">Aprobado</span>
                        {{else}}
                        <span class="status-badge status-pending">Pendiente</span>
                        {{end}}
                    </td>
                    <td>
                        {{if eq .IsAdmin.Int64 1}}
                        <span class="role-badge role-admin">Admin</span>
                        {{else}}
                        <span class="role-badge role-user">Usuario</span>
                        {{end}}
                    </td>
                    <td>{{formatDate .CreatedAt}}</td>
                    <td class="actions user-actions">
                        {{if ne .Approved.Int64 1}}
                        <button hx-post="/admin/approve/{{.ID}}" class="btn btn-sm btn-success">Aprobar</button>
                        {{end}}
                        <button hx-post="/admin/user/{{.ID}}/toggle-admin"
                                class="btn btn-sm {{if eq .IsAdmin.Int64 1}}btn-secondary{{else}}btn-primary{{end}}">
                            {{if eq .IsAdmin.Int64 1}}Quitar Admin{{else}}Hacer Admin{{end}}
                        </button>
                        <button class="btn btn-sm btn-warning"
                                onclick="showPasswordModal({{.ID}}, '{{.Nombre}}')">
                            Cambiar Pass
                        </button>
                        {{if ne .Nomina "admin"}}
                        <button hx-delete="/admin/user/{{.ID}}"
                                hx-confirm="Eliminar usuario {{.Nombre}}? Esta accion no se puede deshacer."
                                class="btn btn-sm btn-danger">
                            Eliminar
                        </button>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </section>

    <!-- Modal para cambiar contraseña -->
    <div id="password-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closePasswordModal()">&times;</span>
            <h3>Cambiar Contraseña</h3>
            <p id="modal-user-name"></p>
            <form id="password-form" onsubmit="submitPasswordChange(event)">
                <input type="hidden" id="modal-user-id" name="user_id">
                <div class="form-group">
                    <label>Nueva Contraseña</label>
                    <input type="password" name="new_password" id="new-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar Contraseña</label>
                    <input type="password" id="confirm-password" required minlength="6">
                </div>
                <div id="password-error" class="alert alert-error" style="display:none;"></div>
                <div id="password-success" class="alert alert-success" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
            </form>
        </div>
    </div>

    <style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-content {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: var(--radius);
        max-width: 400px;
        width: 90%;
        position: relative;
    }
    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
    }
    .modal-close:hover {
        color: var(--danger);
    }
    </style>

    <script>
    function showPasswordModal(userId, userName) {
        document.getElementById('modal-user-id').value = userId;
        document.getElementById('modal-user-name').textContent = 'Usuario: ' + userName;
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('password-error').style.display = 'none';
        document.getElementById('password-success').style.display = 'none';
        document.getElementById('password-modal').style.display = 'flex';
    }

    function closePasswordModal() {
        document.getElementById('password-modal').style.display = 'none';
    }

    async function submitPasswordChange(e) {
        e.preventDefault();
        const userId = document.getElementById('modal-user-id').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const errorDiv = document.getElementById('password-error');
        const successDiv = document.getElementById('password-success');

        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        if (newPassword !== confirmPassword) {
            errorDiv.textContent = 'Las contraseñas no coinciden';
            errorDiv.style.display = 'block';
            return;
        }

        if (newPassword.length < 6) {
            errorDiv.textContent = 'La contraseña debe tener al menos 6 caracteres';
            errorDiv.style.display = 'block';
            return;
        }

        try {
            const formData = new FormData();
            formData.append('new_password', newPassword);

            const response = await fetch('/admin/user/' + userId + '/password', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                successDiv.textContent = 'Contraseña actualizada correctamente';
                successDiv.style.display = 'block';
                setTimeout(closePasswordModal, 2000);
            } else {
                const text = await response.text();
                errorDiv.textContent = text || 'Error al cambiar contraseña';
                errorDiv.style.display = 'block';
            }
        } catch (err) {
            errorDiv.textContent = 'Error de conexión';
            errorDiv.style.display = 'block';
        }
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('password-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePasswordModal();
        }
    });
    </script>
</div>
    </main>
    <footer class="footer">
        <p>AQUILA - IRIS IA Chat</p>
    </footer>
</body>
</html>
{{end}}
