{{define "content"}}
<div class="chat-container">
    <div class="chat-header">
        <h2>Chat Grupal</h2>
        <span id="online-status" class="online-indicator">Conectando...</span>
    </div>

    <div id="chat-messages" class="chat-messages">
        {{range .Messages}}
        <div class="message {{if eq .UserID $.User.ID}}message-own{{end}}">
            <div class="message-header">
                <span class="message-author">{{.Nombre}}</span>
                <span class="message-time">{{.CreatedAt}}</span>
            </div>
            <div class="message-content">{{.Content}}</div>
        </div>
        {{end}}
    </div>

    <div id="error-container" class="error-container" style="display: none;"></div>

    <form id="chat-form" class="chat-input-form">
        <input type="text" id="message-input" name="content"
               placeholder="Escribe un mensaje..."
               autocomplete="off" maxlength="2000">
        <button type="submit" class="btn btn-primary">Enviar</button>
    </form>
</div>

<script>
(function() {
    const messagesContainer = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const onlineStatus = document.getElementById('online-status');
    const errorContainer = document.getElementById('error-container');

    let ws;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${protocol}//${window.location.host}/chat/ws`);

        ws.onopen = function() {
            onlineStatus.textContent = 'Conectado';
            onlineStatus.className = 'online-indicator connected';
            reconnectAttempts = 0;
            hideError();
        };

        ws.onclose = function() {
            onlineStatus.textContent = 'Desconectado';
            onlineStatus.className = 'online-indicator disconnected';

            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connect, 2000 * reconnectAttempts);
            } else {
                showError('Conexion perdida. Recarga la pagina para reconectar.');
            }
        };

        ws.onerror = function() {
            onlineStatus.textContent = 'Error';
            onlineStatus.className = 'online-indicator error';
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'error') {
                showError(data.content);
                return;
            }

            const messageDiv = document.createElement('div');

            if (data.type === 'system') {
                messageDiv.className = 'message message-system';
                messageDiv.innerHTML = `<div class="message-content">${escapeHtml(data.content)}</div>`;
            } else {
                const isOwn = data.user_id === {{.User.ID}};
                messageDiv.className = `message ${isOwn ? 'message-own' : ''}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(data.nombre)}</span>
                        <span class="message-time">${data.timestamp}</span>
                    </div>
                    <div class="message-content">${escapeHtml(data.content)}</div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        };
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = messageInput.value.trim();

        if (content && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ content: content }));
            messageInput.value = '';
            hideError();
        }
    });

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showError(message) {
        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
        setTimeout(hideError, 5000);
    }

    function hideError() {
        errorContainer.style.display = 'none';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    connect();
    scrollToBottom();
})();
</script>
{{end}}

{{template "base" .}}
